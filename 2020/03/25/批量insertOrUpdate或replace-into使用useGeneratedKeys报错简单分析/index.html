<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>批量insertOrUpdate或replace-into使用useGeneratedKeys报错简单分析 | Hexo</title><meta name="description" content="批量insertOrUpdate或replace-into使用useGeneratedKeys报错简单分析"><meta name="keywords" content="Java,Mysql"><meta name="author" content="海东青"><meta name="copyright" content="海东青"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="批量insertOrUpdate或replace-into使用useGeneratedKeys报错简单分析"><meta name="twitter:description" content="批量insertOrUpdate或replace-into使用useGeneratedKeys报错简单分析"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="批量insertOrUpdate或replace-into使用useGeneratedKeys报错简单分析"><meta property="og:url" content="https://haohaogit.github.io/2020/03/25/%E6%89%B9%E9%87%8FinsertOrUpdate%E6%88%96replace-into%E4%BD%BF%E7%94%A8useGeneratedKeys%E6%8A%A5%E9%94%99%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/"><meta property="og:site_name" content="Hexo"><meta property="og:description" content="批量insertOrUpdate或replace-into使用useGeneratedKeys报错简单分析"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://haohaogit.github.io/2020/03/25/%E6%89%B9%E9%87%8FinsertOrUpdate%E6%88%96replace-into%E4%BD%BF%E7%94%A8useGeneratedKeys%E6%8A%A5%E9%94%99%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/"><link rel="prev" title="数据库全表查询之-分页查询优化" href="https://haohaogit.github.io/2020/03/30/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%85%A8%E8%A1%A8%E6%9F%A5%E8%AF%A2%E4%B9%8B-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/"><link rel="next" title="生成唯一有序的编号-使用redis" href="https://haohaogit.github.io/2020/03/25/%E7%94%9F%E6%88%90%E5%94%AF%E4%B8%80%E6%9C%89%E5%BA%8F%E7%9A%84%E7%BC%96%E5%8F%B7-%E4%BD%BF%E7%94%A8redis/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: {"languages":{"author":"作者: 海东青","link":"链接: https://haohaogit.github.io/2020/03/25/%E6%89%B9%E9%87%8FinsertOrUpdate%E6%88%96replace-into%E4%BD%BF%E7%94%A8useGeneratedKeys%E6%8A%A5%E9%94%99%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/","source":"来源: Hexo","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.1.1"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Hexo</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/haiDongQing.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">35</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">7</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#现象"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">现象</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#利用批量InsertOrUpdate的userGeneratedKey来返回自增主键"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">利用批量InsertOrUpdate的userGeneratedKey来返回自增主键</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#结论"><span class="toc_mobile_items-number"></span> <span class="toc_mobile_items-text">结论</span></a></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#现象"><span class="toc-number">1.</span> <span class="toc-text">现象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#利用批量InsertOrUpdate的userGeneratedKey来返回自增主键"><span class="toc-number">2.</span> <span class="toc-text">利用批量InsertOrUpdate的userGeneratedKey来返回自增主键</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#结论"><span class="toc-number"></span> <span class="toc-text">结论</span></a></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">批量insertOrUpdate或replace-into使用useGeneratedKeys报错简单分析</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 发表于 2020-03-25<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> 更新于 2020-08-06</time><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>阅读量:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><p> &#160; &#160; 在项目中我们经常使用useGenerateKeys来返回自增主键，避免多一次查询。在项目中不管是单条数据插入还是批量数据插入，用此方法获取自增主键ID屡试不爽。当然也会使用on duplicate key update，来进行insertOrUpdate，来避免必须先query后才觉得是insert还是update。这招用起来很爽，但是也容易不知所以的掉坑，鄙人在一次批量更新的时候使用到了useGenerateKeys导致项目保错，促使我要研究一下使用useGenerateKeys的内部原理和使用奥秘。</p>
<h4 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h4><p>先贴出我出错的两段代码：</p>
<ul>
<li><p>批量插入或更新商品对象：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">java</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Long&gt; <span class="title">batchUpdateItems</span><span class="params">(List&lt;ItemPO&gt; itemPOS)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isNotEmpty(itemPOS)) &#123;</span><br><span class="line">        <span class="keyword">int</span> count = itemNewDAO.batchUpdateItem(itemPOS);</span><br><span class="line">        <span class="keyword">if</span> (count != itemPOS.size()) &#123;</span><br><span class="line">            log.info(<span class="string">"批量更新商品信息失败"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> itemPOS.stream().map(ItemPO::getId).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Lists.newArrayList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li>
<li><p>使用replace-into:</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id="batchUpdateItem" useGeneratedKeys="true" keyProperty="id"&gt;</span><br><span class="line">    <span class="keyword">REPLACE</span> <span class="keyword">INTO</span> item (<span class="keyword">id</span>, item_id, sku_id,</span><br><span class="line">    <span class="string">`name`</span>, tags,unit_price, <span class="string">`type`</span>,quantity, creator, modifier,gmt_created, gmt_modified, is_del)</span><br><span class="line">    <span class="keyword">values</span></span><br><span class="line">    &lt;foreach collection=<span class="string">"records"</span> <span class="keyword">index</span>=<span class="string">"index"</span> item=<span class="string">"item"</span> separator=<span class="string">","</span>&gt;</span><br><span class="line">      (</span><br><span class="line">      <span class="comment">#&#123;item.id,jdbcType=BIGINT&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.itemId,jdbcType=BIGINT&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.skuId,jdbcType=BIGINT&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.name,jdbcType=VARCHAR&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.tags,jdbcType=VARCHAR&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.unitPrice,jdbcType=BIGINT&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.type,jdbcType=CHAR&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.quantity,jdbcType=BIGINT&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.creator,jdbcType=BIGINT&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.modifier,jdbcType=BIGINT&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.gmtCreated,jdbcType=TIMESTAMP&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.gmtModified,jdbcType=TIMESTAMP&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.isDel,jdbcType=BIT&#125;</span></span><br><span class="line">      )</span><br><span class="line">    &lt;/foreach&gt;</span><br><span class="line">  &lt;/<span class="keyword">insert</span>&gt;</span><br></pre></td></tr></table></figure></div></li>
<li><p>使用on duplicate key：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">sql</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id="batchUpdateItem" useGeneratedKeys="true" keyProperty="id"&gt;</span><br><span class="line">    <span class="keyword">insert</span> <span class="keyword">into</span> item (<span class="keyword">id</span>, item_id, sku_id,</span><br><span class="line">    <span class="string">`name`</span>, tags,unit_price, <span class="string">`type`</span>,quantity, creator, modifier,gmt_created, gmt_modified, is_del)</span><br><span class="line">    <span class="keyword">values</span></span><br><span class="line">    &lt;foreach collection=<span class="string">"records"</span> <span class="keyword">index</span>=<span class="string">"index"</span> item=<span class="string">"item"</span> separator=<span class="string">","</span>&gt;</span><br><span class="line">      (</span><br><span class="line">      <span class="comment">#&#123;item.id,jdbcType=BIGINT&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.itemId,jdbcType=BIGINT&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.skuId,jdbcType=BIGINT&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.name,jdbcType=VARCHAR&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.tags,jdbcType=VARCHAR&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.unitPrice,jdbcType=BIGINT&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.type,jdbcType=CHAR&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.quantity,jdbcType=BIGINT&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.creator,jdbcType=BIGINT&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.modifier,jdbcType=BIGINT&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.gmtCreated,jdbcType=TIMESTAMP&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.gmtModified,jdbcType=TIMESTAMP&#125;,</span></span><br><span class="line">      <span class="comment">#&#123;item.isDel,jdbcType=BIT&#125;</span></span><br><span class="line">      )</span><br><span class="line">    &lt;/foreach&gt;</span><br><span class="line">    <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span></span><br><span class="line">  &lt;/<span class="keyword">insert</span>&gt;</span><br></pre></td></tr></table></figure></div>
<p>&#160; &#160; 我想当然的<font color="orange">认为批量更新（insertOrUpdate）返回的行数就是数据库受影响的行数；</font>实际情况中很大概率会遇到错误提示为：“Too many keys are generated. There are only 1 target objects. You either specified a wrong ‘keyProperty’ or encountered a driver bug like #1523.”  </p>
</li>
<li><p>查看<a href="https://dev.mysql.com/doc/refman/5.6/en/insert-on-duplicate.html" target="_blank" rel="noopener">官方文档</a></p>
<p> With ON DUPLICATE KEY UPDATE, the affected-rows value per row is 1 if the row is inserted as a new row, 2 if an existing row is updated, and 0 if an existing row is set to its current values. If you specify the CLIENT_FOUND_ROWS flag to the mysql_real_connect() C API function when connecting to mysqld, the affected-rows value is 1 (not 0) if an existing row is set to its current values. </p>
</li>
</ul>
<p>返回值有3种：</p>
<ul>
<li><p>0；没有行更新</p>
</li>
<li><p>1；insert</p>
</li>
<li><p>2；update<br>由此看出代码块1中的判断是明显达不到预期结果了；</p>
<h4 id="利用批量InsertOrUpdate的userGeneratedKey来返回自增主键"><a href="#利用批量InsertOrUpdate的userGeneratedKey来返回自增主键" class="headerlink" title="利用批量InsertOrUpdate的userGeneratedKey来返回自增主键"></a>利用批量InsertOrUpdate的userGeneratedKey来返回自增主键</h4><p>在批量插入数据时有update时，就会发现这个问题，返回的自增主键都是错误的，这是为什么呢？</p>
</li>
<li><p>首先我们看下mybatis对于useGeneratedKey的描述   </p>
<p>  This tells MyBatis to use the JDBC getGeneratedKeys method to retrieve keys generated internally by the database (e.g. auto increment fields in RDBMS like MySQL or SQL Server). Default: false.</p>
</li>
</ul>
<p>就是使用JDBC的getGeneratedKeys的方法来获取的。</p>
<ul>
<li><p>我们再看下<a href="https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-usagenotes-last-insert-id.html" target="_blank" rel="noopener">JDBC规范</a><br>  Before version 3.0 of the JDBC API, there was no standard way of retrieving key values from databases that supported auto increment or identity columns. With older JDBC drivers for MySQL, you could always use a MySQL-specific method on the Statement interface, or issue the query SELECT LAST_INSERT_ID() after issuing an INSERT to a table that had an AUTO_INCREMENT key. Using the MySQL-specific method call isn’t portable, and issuing a SELECT to get the AUTO_INCREMENT key’s value requires another round-trip to the database, which isn’t as efficient as possible. The following code snippets demonstrate the three different ways to retrieve AUTO_INCREMENT values. First, we demonstrate the use of the new JDBC 3.0 method getGeneratedKeys() which is now the preferred method to use if you need to retrieve AUTO_INCREMENT keys and have access to JDBC 3.0. The second example shows how you can retrieve the same value using a standard SELECT LAST_INSERT_ID() query. The final example shows how updatable result sets can retrieve the AUTO_INCREMENT value when using the insertRow() method.</p>
<p>&#160; &#160; 意思就是JDBC3.0以前，有些乱七八糟的定义的，没有统一，之后统一成了getGeneratedKeys()方法。两边是一致的。实现的原理主要就是数据库端返回一个LAST_INSERT_ID。这个跟auto_increment_id强相关。</p>
</li>
<li><p>我们看下<a href="https://dev.mysql.com/doc/refman/8.0/en/example-auto-increment.html" target="_blank" rel="noopener">auto_increment_id的定义</a>。重点关注批量插入    </p>
<p>  For a multiple-row insert, LAST_INSERT_ID() and mysql_insert_id() actually return the AUTO_INCREMENT key from the first of the inserted rows. This enables multiple-row inserts to be reproduced correctly on other servers in a replication setup.</p>
<p>&#160; &#160; 批量插入的时候只会返回一个id，这个id值是第一个插入行的AUTO_INCREMENT值。至于为什么这么干，能够使得mysql-server在master-slave架构下也能保证id值统一的原因可以看下这篇。本篇文章就不展开了。</p>
<p>&#160; &#160; 那么mysql server只返回一个id，客户端批量插入的时候怎么能实现获取全部的id呢？<font color="green">首先获取本次批量插入的影响行数，然后再执行具体的获取id操作。即按照受影响的范围+递增步长，迭代影响的行数，然后依次获取id。</font>  </p>
<p>&#160; &#160; 所以批量insert是正确可以返回的。<br>&#160; &#160; 但是批量insertOrUpdate就有问题了，批量insertOrUpdate的影响行数不是插入的数据行数，可能是0，1，2这样就导致了自增id有问题了。比如插入3条数据，2条会update,1条会insert,这时候updateCount就是5，generateid就会5个了，mybatis然后取前3个塞到数据里，显然是错的。</p>
</li>
</ul>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><ul>
<li>批量insertOrUpdate时，不能依赖useGeneratedKey返回主键。</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">海东青</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://haohaogit.github.io/2020/03/25/%E6%89%B9%E9%87%8FinsertOrUpdate%E6%88%96replace-into%E4%BD%BF%E7%94%A8useGeneratedKeys%E6%8A%A5%E9%94%99%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">https://haohaogit.github.io/2020/03/25/%E6%89%B9%E9%87%8FinsertOrUpdate%E6%88%96replace-into%E4%BD%BF%E7%94%A8useGeneratedKeys%E6%8A%A5%E9%94%99%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://haohaogit.github.io">Hexo</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java    </a><a class="post-meta__tags" href="/tags/Mysql/">Mysql    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.png" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/aliPay.png" alt="支付宝"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/03/30/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%85%A8%E8%A1%A8%E6%9F%A5%E8%AF%A2%E4%B9%8B-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>数据库全表查询之-分页查询优化</span></div></a></div><div class="next-post pull_right"><a href="/2020/03/25/%E7%94%9F%E6%88%90%E5%94%AF%E4%B8%80%E6%9C%89%E5%BA%8F%E7%9A%84%E7%BC%96%E5%8F%B7-%E4%BD%BF%E7%94%A8redis/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>生成唯一有序的编号-使用redis</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/12/22/mybaties做批量数据操作，报org-apache-ibatis-binding-BindingException异常/" title="mybaties做批量数据操作，报org.apache.ibatis.binding.BindingException异常"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-12-15</div><div class="relatedPosts_title">mybaties做批量数据操作，报org.apache.ibatis.binding.BindingException异常</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/14/总结使用Mybatis-generator遇到的坑/" title="总结使用Mybatis-generator遇到的坑"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-12-15</div><div class="relatedPosts_title">总结使用Mybatis-generator遇到的坑</div></div></a></div><div class="relatedPosts_item"><a href="/2020/01/02/ES数据和数据库数据不一致时怎么办？/" title="ES数据和数据库数据不一致时怎么办？"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-12-15</div><div class="relatedPosts_title">ES数据和数据库数据不一致时怎么办？</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/26/Maven学习之路-jar依赖范围（-scope-）/" title="Maven学习之路-jar依赖范围（<scope />）"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-12-15</div><div class="relatedPosts_title">Maven学习之路-jar依赖范围（<scope />）</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/25/mac-更改“hosts”文件遇到的一个坑/" title="mac 更改“hosts”文件遇到的一个坑"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-12-15</div><div class="relatedPosts_title">mac 更改“hosts”文件遇到的一个坑</div></div></a></div><div class="relatedPosts_item"><a href="/2019/12/26/服务调用之《dubbo直连和通过ZK连接》/" title="服务调用之《dubbo直连和通过ZK连接》"><img class="relatedPosts_cover lazyload"data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-12-15</div><div class="relatedPosts_title">服务调用之《dubbo直连和通过ZK连接》</div></div></a></div></div><div class="clear_both"></div></div></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By 海东青</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">简</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>